---
import { ExternalLink, ArrowRight } from "@lucide/astro";
import { Image } from "astro:assets";
import { Markdown, markdown } from "@astropub/md";
import type { CollectionEntry } from "astro:content";
import { IconsMap } from "./consts.ts";

interface Props {
  project: CollectionEntry<"product">;
  compact?: boolean;
}

const { project, compact = false } = Astro.props;
const Icon = IconsMap[project.data.type].Icon;
---

<div
  transition:name={`project_${project.id}`}
  class={`group relative bg-white rounded-[2.5rem] border border-slate-200 overflow-hidden shadow-sm hover:shadow-2xl hover:border-indigo-100 transition-all flex flex-col h-full ${compact ? "shadow-sm" : "shadow-md"}`}
>
  <div
    class={`relative overflow-hidden bg-slate-50 ${compact ? "h-40" : "h-56 lg:h-64"}`}
  >
    {
      project.data.thumbnail ? (
        <>
          <Image
            width={1920}
            height={1080}
            src={project.data.thumbnail}
            alt={project.data.title}
            class="w-full h-full object-contain group-hover:scale-110 transition-transform duration-700"
            referrerpolicy="no-referrer"
          />
          <div class="absolute inset-0 bg-linear-30 from-black/30 via-black/5 to-black/15" />
        </>
      ) : (
        <div class="absolute inset-0 bg-linear-to-br from-slate-50 to-slate-100 flex items-center justify-center">
          <div
            class="w-full h-full opacity-15 absolute top-0 left-0 z-0"
            style={{
              backgroundImage: "radial-gradient(#6366f1 1px, transparent 1px)",
              backgroundSize: "20px 20px",
            }}
          />
          <Icon
            size={compact ? 64 : 80}
            class="text-slate-200 group-hover:text-indigo-100 duration-500 z-1 group-hover:scale-130 transition"
          />
        </div>
      )
    }

    {/* Overlay Metadata */}
    <div class="absolute inset-0 p-6 lg:p-8 flex items-start justify-between">
      <div
        class={`bg-white/90 backdrop-blur-md rounded-2xl shadow-lg text-indigo-600 group-hover:scale-110 transition-transform duration-500 ${compact ? "p-2" : "p-3"}`}
      >
        <Icon size={compact ? 24 : 30} />
      </div>
      <span
        class={`px-3 py-1 text-[10px] rounded-full font-black uppercase tracking-widest border backdrop-blur-md ${
          project.data.type === "product"
            ? "bg-amber-50/90 text-amber-600 border-amber-100/50"
            : project.data.type === "package"
              ? "bg-red-50/90 text-red-600 border-red-100/50"
              : "bg-indigo-50/90 text-indigo-600 border-indigo-100/50"
        }`}
      >
        {IconsMap[project.data.type].name}
      </span>
    </div>
  </div>

  <div class={`${compact ? "p-6" : "p-8 lg:p-10"} flex flex-col flex-1`}>
    <h3
      class={`${compact ? "text-lg" : "text-2xl lg:text-3xl"} font-black text-slate-900 mb-2 group-hover:text-indigo-600 transition-colors line-clamp-1`}
    >
      {project.data.title}
    </h3>

    <div
      class={`text-slate-500 ${compact ? "text-sm" : "text-lg"} leading-relaxed mb-4 flex-1 line-clamp-3`}
      title={project.data.description}
    >
      <Markdown of={project.data.description} />
    </div>

    <div class="flex flex-wrap gap-2 mb-8">
      {
        project.data.tech?.map((t) => (
          <span class="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-0.5 rounded-md border border-slate-100">
            {t}
          </span>
        ))
      }
    </div>

    <div class="mt-auto">
      {
        project.data.isExternal ? (
          <a
            href={project.data.link}
            target="_blank"
            rel="noopener noreferrer"
            class={`inline-flex items-center gap-2 text-indigo-600 font-black hover:gap-3 transition-all group/link ${compact ? "text-xs" : "text-base"}`}
          >
            Ver recurso{" "}
            <ExternalLink
              size={compact ? 14 : 18}
              class="group-hover/link:rotate-12 transition-transform"
            />
          </a>
        ) : (
          <a
            target="_blank"
            href={new URL(project.data.link, Astro.url)}
            class={`inline-flex items-center gap-2 text-indigo-600 font-black hover:gap-3 transition-all group/link ${compact ? "text-xs" : "text-base"}`}
          >
            Acceder{" "}
            <ArrowRight
              size={compact ? 14 : 18}
              class="group-hover/link:translate-x-1 transition-transform"
            />
          </a>
        )
      }
    </div>
  </div>
</div>
