---
import FormattedDate from "@/components/FormattedDate.astro";
import JsonLd from "@/components/layout/JsonLd.astro";
import WebsiteLayout from "@/layouts/WebsiteLayout.astro";
import { getBreadcrumbSchema } from "@/utils/jsonld";
import { ArrowLeft, Calendar, Share2 } from "@lucide/astro";
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import { type CollectionEntry, getCollection, render } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog", (e) => e.data.published);
  return posts.map((post) => ({
    params: { slug: post.id },
    props: post,
  }));
}
type Props = CollectionEntry<"blog">;

const post = Astro.props;
const categories = await getCollection("category", (e) =>
  post.data.categories.includes(e.data.title),
);

const breadcrumbSchema = getBreadcrumbSchema([
  { name: "Inicio", item: "/" },
  { name: "Blog", item: "/blog" },
  { name: post.data.title, item: `/blog/${post.id}` },
]);

const { Content } = await render(post);
---

<WebsiteLayout
  seoProps={{
    title: post.data.title,
    description: post.data.description,
    image: { src: post.data.image, format: "jpg", height: 1080, width: 1920 },
    type: "article",
  }}
>
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <button
      class="inline-flex items-center gap-2 text-slate-500 hover:text-indigo-600 mb-10 transition-colors group"
      onclick="backToBlog()"
    >
      <ArrowLeft
        size={20}
        class="group-hover:-translate-x-1 transition-transform"
      /> Volver al blog
    </button>

    <header class="mb-12">
      <div class="flex items-center gap-3 mb-6">
        {
          post.data.categories.map((c) => (
            <a
              href={`/blog/categoria/${categories.find((cat) => c === cat.data.title)?.id ?? ""}`}
              class="bg-indigo-100 dark:bg-indigo-900/75 text-indigo-600 dark:text-indigo-300 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider"
            >
              {c}
            </a>
          ))
        }
        <span class="text-slate-400 text-sm flex items-center gap-1">
          <Calendar size={14} />
          <FormattedDate date={post.data.date} />
        </span>
      </div>
      <h1
        class="text-4xl sm:text-5xl lg:text-6xl font-black leading-tight mb-8"
      >
        {post.data.title}
      </h1>
      <div
        class="flex items-center gap-4 border-y border-slate-200/90 dark:border-slate-700/50 py-6"
      >
        <Image
          width={50}
          height={50}
          loading="eager"
          src="/images/daniel.jpg"
          alt="Daniel Gonzalez Cuetara"
          class="w-12 h-12 rounded-full border-2 border-indigo-100 dark:border-indigo-600"
        />
        <div class="flex-1">
          <p class="font-bold">Daniel Gonzalez Cuetara</p>
          <p class="text-xs text-slate-500">
            CoreX4Dev • Content Creator & Dev
          </p>
        </div>

        <button
          id="shareButton"
          onclick="share()"
          class="p-2 text-slate-400 hover:text-indigo-600 transition-colors"
          aria-label="Compartir artículo"
        >
          <Share2 size={20} />
        </button>
      </div>
    </header>

    <div
      class="relative rounded-4xl overflow-hidden mb-16 shadow-2xl"
      transition:name={`post-${post.id}-image`}
    >
      <Image
        width={1920}
        height={1080}
        src={post.data.image}
        alt={post.data.title}
        loading="eager"
        class="w-full h-auto object-cover"
      />
    </div>

    <div
      class="prose prose-lg max-w-none prose-slate dark:prose-invert prose-headings:font-black prose-a:text-indigo-600 dark:prose-a:text-indigo-400 prose-img:rounded-3xl leading-relaxed text-slate-700 dark:text-slate-400"
    >
      <Content />
    </div>

    {
      post.data.youtubeId && (
        <footer class="mt-20 pt-12 border-t border-slate-200 dark:border-slate-700/50">
          <div class="bg-slate-50 dark:bg-slate-900 rounded-[2.5rem] p-8 sm:p-12 flex flex-col md:flex-row gap-8 items-center">
            <div class="flex-1 text-center md:text-left">
              <h3 class="text-2xl font-bold mb-4 flex items-center justify-center md:justify-start gap-3">
                <Icon name="fa7-brands:youtube" class="text-red-600" />{" "}
                ¿Prefieres el vídeo?
              </h3>
              <p class="text-slate-600 dark:text-slate-500 text-lg mb-6">
                He preparado un vídeo detallado sobre este mismo tema en mi
                canal CoreX4Dev. ¡No te lo pierdas!
              </p>
              <a
                href={post.data.youtubeId}
                target="_blank"
                class="inline-block bg-red-600 text-white px-8 py-3 rounded-2xl font-bold hover:bg-red-700 dark:shadow-red-900 transition-colors shadow-lg shadow-red-100"
              >
                Ver Vídeo en YouTube
              </a>
            </div>
            <div class="w-full md:w-1/3 aspect-video bg-slate-200 rounded-2xl overflow-hidden shadow-inner flex items-center justify-center">
              <Icon
                name="fa7-brands:youtube"
                size={48}
                class="text-slate-400"
              />
            </div>
          </div>
        </footer>
      )
    }
  </article>

  <JsonLd schema={breadcrumbSchema} />
</WebsiteLayout>

<script is:inline>
  function share() {
    const shareData = { url: window.location.href, title: document.title };
    if (navigator.canShare(shareData)) {
      navigator.share(shareData);
    } else {
      navigator.clipboard.writeText(window.location.href);
      alert(
        "Tu navegador no es compatible con compartir contenido. El enlace de la página se ha copiado al portapapeles",
      );
    }
  }

  function backToBlog() {
    if (window.history.length > 1 && document.referrer) {
      window.history.back();
    } else {
      window.location.href = new URL("/blog", window.location.href);
    }
  }
</script>
